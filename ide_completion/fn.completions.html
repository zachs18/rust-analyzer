<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Main entry point for completion. We run completion as a two-phase process."><meta name="keywords" content="rust, rustlang, rust-lang, completions"><title>completions in ide_completion - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" type="text/css" href="../normalize.css"><link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../ayu.css" disabled><link rel="stylesheet" type="text/css" href="../dark.css" disabled><link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../storage.js"></script><script src="../crates.js"></script><script defer src="../main.js"></script>
    <noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../favicon.svg"></head><body class="rustdoc fn"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../ide_completion/index.html"><div class="logo-container"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></div>
        </a><h2 class="location"></h2>
    </nav>
    <nav class="sidebar"><a class="sidebar-logo" href="../ide_completion/index.html"><div class="logo-container"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></div>
        </a><div class="sidebar-elems"><h2 class="location"><a href="index.html">In ide_completion</a></h2><div id="sidebar-vars" data-name="completions" data-ty="fn" data-relpath=""></div><script defer src="sidebar-items.js"></script></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../ide_completion/index.html"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></a><nav class="sub"><div class="theme-picker hidden"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu" title="themes"><img width="22" height="22" alt="Pick another theme!" src="../brush.svg"></button><div id="theme-choices" role="menu"></div></div><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><button type="button" id="help-button" title="help">?</button><a id="settings-menu" href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../wheel.svg"></a></div></form></nav></div><section id="main-content" class="content"><div class="main-heading">
    <h1 class="fqn"><span class="in-band">Function <a href="index.html">ide_completion</a>::<wbr><a class="fn" href="#">completions</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../src/ide_completion/lib.rs.html#148-203">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><div class="docblock item-decl"><pre class="rust fn"><code>pub fn completions(<br>&nbsp;&nbsp;&nbsp;&nbsp;db: &amp;<a class="struct" href="../ide_db/struct.RootDatabase.html" title="struct ide_db::RootDatabase">RootDatabase</a>, <br>&nbsp;&nbsp;&nbsp;&nbsp;config: &amp;<a class="struct" href="struct.CompletionConfig.html" title="struct ide_completion::CompletionConfig">CompletionConfig</a>, <br>&nbsp;&nbsp;&nbsp;&nbsp;position: <a class="struct" href="../base_db/struct.FilePosition.html" title="struct base_db::FilePosition">FilePosition</a>, <br>&nbsp;&nbsp;&nbsp;&nbsp;trigger_character: <a class="enum" href="https://doc.rust-lang.org/1.62.1/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/1.62.1/std/primitive.char.html">char</a>&gt;<br>) -&gt; <a class="enum" href="https://doc.rust-lang.org/1.62.1/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;<a class="struct" href="https://doc.rust-lang.org/1.62.1/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="struct.CompletionItem.html" title="struct ide_completion::CompletionItem">CompletionItem</a>&gt;&gt;</code></pre></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Main entry point for completion. We run completion as a two-phase process.</p>
<p>First, we look at the position and collect a so-called `CompletionContext.
This is a somewhat messy process, because, during completion, syntax tree is
incomplete and can look really weird.</p>
<p>Once the context is collected, we run a series of completion routines which
look at the context and produce completion items. One subtlety about this
phase is that completion engine should not filter by the substring which is
already present, it should give all possible variants for the identifier at
the caret. In other words, for</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">fn</span> <span class="ident">f</span>() {
    <span class="kw">let</span> <span class="ident">foo</span> <span class="op">=</span> <span class="number">92</span>;
    <span class="kw">let</span> <span class="kw">_</span> <span class="op">=</span> <span class="ident">bar</span>$<span class="number">0</span>
}</code></pre></div>
<p><code>foo</code> <em>should</em> be present among the completion variants. Filtering by
identifier prefix/fuzzy match should be done higher in the stack, together
with ordering of completions (currently this is done by the client).</p>
<h2 id="speculative-completion-problem"><a href="#speculative-completion-problem">Speculative Completion Problem</a></h2>
<p>There’s a curious unsolved problem in the current implementation. Often, you
want to compute completions on a <em>slightly different</em> text document.</p>
<p>In the simplest case, when the code looks like <code>let x = </code>, you want to
insert a fake identifier to get a better syntax tree: <code>let x = complete_me</code>.</p>
<p>We do this in <code>CompletionContext</code>, and it works OK-enough for <em>syntax</em>
analysis. However, we might want to, eg, ask for the type of <code>complete_me</code>
variable, and that’s where our current infrastructure breaks down. salsa
doesn’t allow such “phantom” inputs.</p>
<p>Another case where this would be instrumental is macro expansion. We want to
insert a fake ident and re-expand code. There’s <code>expand_speculative</code> as a
work-around for this.</p>
<p>A different use-case is completion of injection (examples and links in doc
comments). When computing completion for a path in a doc-comment, you want
to inject a fake path expression into the item being documented and complete
that.</p>
<p>IntelliJ has CodeFragment/Context infrastructure for that. You can create a
temporary PSI node, and say that the context (“parent”) of this node is some
existing node. Asking for, eg, type of this <code>CodeFragment</code> node works
correctly, as the underlying infrastructure makes use of contexts to do
analysis.</p>
</div></details></section></div></main><div id="rustdoc-vars" data-root-path="../" data-current-crate="ide_completion" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.62.1 (e092d0b6b 2022-07-16)" ></div>
</body></html>